<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <style>

        .node circle {
          fill: #FFF;
          /*fill: #00B2EE;*/
          stroke: steelblue;
          stroke-width: .5px;
        }

        .node {
          font: 10px sans-serif;
        }

        .link {
          fill: none;
          stroke: #ccd;
          stroke-width: 1.5px;
        }
          
        li {
          font: 10px sans-serif;
        }
        
        #tree {
          margin-top: -20;
        }
        
        /* Style the buttons that are used to open and close the accordion panel */
        button.accordion {
          background-color: #eee;
          color: #444;
          cursor: pointer;
          padding: 18px;
          width: 100%;
          text-align: left;
          border: none;
          outline: none;
          transition: 0.4s;
        }

        /* Add a background color to the button if it is clicked on (add the .active class with JS), and when you move the mouse over it (hover) */
        button.accordion.active, button.accordion:hover {
          background-color: #ddd;
        }

        /* Style the accordion panel. Note: hidden by default */
        div.panel {
          padding: 0 18px;
          background-color: white;
          display: none;
        }
          
        </style>

        <title>D3 Test</title>
    </head>
    <body>      
        <script type="text/javascript" src="./CollapsibleLists.js"></script>
        <script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
        <link rel="stylesheet" type="text/css" href="toggleSwitchStyle.css" media="screen">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <style> 
          .btn {
            display: block; 
            padding-top: 10px;
            padding-bottom: 10px;
            margin-top: 10px;
            margin-bottom: 10px;
          }
          .btn_main {
            display: block; 
            padding-top: 10px;
            padding-bottom: 10px;
            margin-top: 10px;
            margin-bottom: 10px;
            border-radius: 10px;
            background-color: #4CAF50;
            color: white;
            padding: 16px;
            font-size: 16px;
            border: none;
            cursor: pointer;
          }
        </style>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
      
        <div style="padding-left: 20px">
           <h1>Non-Covalent Contacts in GPCRS - Dynamics</h1>
        </div>
      
        <div style="width: 100%;">
          <div style="float:left; width: 20%; padding-top: 10px; padding-left: 20px">
            <button onclick="location.href = 'structures_index.html';" type='button' class='btn_main'>STRUCTURES</button>
            <h1 style='padding-bottom: 5px'>Receptors</h1>
            <div id="searchContainer" class="cf sb" style='padding-bottom: 10px'>
              <input class="right" type="text" id="searchBox" placeholder="search"/>
            </div>
            <div id= "intermediary">
            </div>
          </div>
          <div id="tree" style="float:right; width: 80%">
          </div>
        </div>
        <div style="clear:both"></div>

        <script src="https://d3js.org/d3.v3.js"></script>
        <!--<script type="text/javascript" src="d3.v3.js"></script>-->
      
        <script>
          
          //CHECK IF REACHED VIA BACKBUTTON
          $(document).ready(function(e) {
            var $input = $('#refresh');

            $input.val() == 'yes' ? location.reload(true) : $input.val('yes');
          });
          
          
          var single = false;
          var counter = 0;
      
          
        //$(window).bind("backward", function() {
        //  location.reload();
        //});
          
        
          
        function createAll() {
          
          $('#searchContainer').on('keyup', function(e){
            var code = e.which; // recommended to use e.which, it's normalized across browsers
            if(code==13)e.preventDefault();
            if(code==32||code==13||code==188||code==186){
              //var searchTerm = $("#searchbox").val().toLowerCase();
              var searchstring = $('#searchBox');
              searchstring.focus();
              var searchTerm = searchstring.val();
              var json;
              var code = [];
              var j = 0;
              $.getJSON('table.json').done(function (data) {
                json = data;
                for(var i = 0; i < json.length; i++) {
                  var obj = json[i];
                  console.log(searchTerm)
                  if(obj.uniprot.includes(searchTerm)) {
                    code[j] = obj;  
                    j = j + 1;
                  }
                }
              $("#list").remove();
              $("#collaps").remove();
              $(".btn").remove();
              for (var i = 0; i < counter; i++) {
                $("#list" + i + "").remove();
                $("#collaps" + i + "").remove();
              }
              counter = 0;
              for(var i in code) {
                $("#intermediary").append("<button type='button' class='btn btn-info' data-toggle='collapse' data-target='#collaps" + i + "'>" + code[i].pdb + "</button>");
                $("#intermediary").append("<div id='collaps" + i + "' class='collapse'></div>");
                $("#collaps" + i + "").append("<ul id='list" + i + "'></ul>");
                var li = "<li id=first><a href='"; 
                var name = "radialProt.html?name=" + code[i].pdb + "&plotname=" + code[i].short_exp_cond_description + "&uniprot=" + code[i].uniprot + "&status=" + single + "&singleName=" + code[i].uniprot + "_" + code[i].pdb + "_" + code[i].vmd_chain_id.charAt(0) +  "'>"+code[i].pdb;
                $("#list" + i + "").append(li.concat(name))
                  .append("<li>".concat("Receptor: " + code[i].receptor))
                  .append("<li>".concat("Uniprot: " + code[i].uniprot))
                  .append("<li>".concat("State: " + code[i].state))
                  .append("<li>".concat("Ligand: " + code[i].ligand))
                  .append("<li>".concat("Publication: " + code[i].publication))
                  .append("<li>".concat("Condition/Rep: " + code[i]['condition/rep']))
                  .append("<li>".concat("Sherlock Path: " + code[i].sherlock_path))
                  .append("<li>".concat("Top Dir: " + code[i].top_dir))
                  .append("<li>".concat("Traj Dir: " + code[i].traj_dir))
                  .append("<li>".concat("Filetype: " + code[i].filetype))
                  .append("<li>".concat("Sim Tool: " + code[i].sim_tool))
                  .append("<li>".concat("Strip Water: " + code[i].strip_water))
                  .append("<li>".concat("VMD Chain ID: " + code[i].vmd_chain_id))
                  .append("<li>".concat("MDTRAJ Chain ID: " + code[i].mdtraj_chain_id))
                  .append("<li>".concat("Short Exp Cond Description: " + code[i].short_exp_cond_description))
                  .append("<li>".concat("Lond Exp Cond Description: " + code[i].long_exp_cond_description))
                  .append("<li>".concat("3.5A Inter Dict Dir: " + code[i]["3.5A_inter_dict_dir"]))
                  .append("<li>".concat("3.2A Inter Dict Dir: " + code[i]["3.2A_inter_dict_dir"]))                
                  .append("<li>".concat("Subsampled Traj: " + code[i].subsampled_traj))
                  .append("<li>".concat("Ligand Resn: " + code[i].ligand_resn));
              counter = i;
              }
              });
            }
        });

        var diameter = document.getElementById("tree").offsetWidth;

        var tree = d3.layout.tree()
            .size([360, diameter / 2.4])
            .separation(function(a, b) { return (a.parent == b.parent ? 1 : 2) / a.depth; });

        var diagonal = d3.svg.diagonal.radial()
            .projection(function(d) { return [d.y, d.x / 180 * Math.PI]; });

        var svg = d3.select("#tree").append("svg")
            .attr("width", diameter)
            .attr("height", diameter - 50)
          .append("g")
            .attr("transform", "translate(" + diameter / 2 + "," + diameter / 2 + ")");

        d3.json("receptors.json", function(error, root) {
          if (error) throw error;

          var nodes = tree.nodes(root),
              links = tree.links(nodes);

          var link = svg.selectAll(".link")
              .data(links)
            .enter().append("path")
              .attr("class", "link")
              .attr("d", diagonal);

          var node = svg.selectAll(".node")
              .data(nodes)
            .enter().append("g")
              .attr("class", "node")
              .attr("transform", function(d) { return "rotate(" + (d.x - 90) + ")translate(" + d.y + ")"; })

          node.append("circle")
              .attr("r", 6.5)
              .attr("id", "circleClicker")
              .style("fill", function(d) {
                var color = "white";
                $.ajax({
                  url: 'table.json',
                  async: false,
                  dataType: 'json',
                  success: function (data) {
                    json = data;
                    for(var i = 0; i < json.length; i++) {
                      var obj = json[i];
                      if(obj.uniprot.includes(d.name)) {
                        if (d.name !== "") {
                          color = "magenta";
                        }
                      }
                    }
                   }
                }); 
                return color;
              })
              .style("cursor", "pointer")
              .on("click", function(d) {
                //window.location = "intermediary.html" + "?name=" + d.name;
              var json;
              var code = [];
              var j = 0;
            
              $.getJSON('table.json').done(function (data) {
                json = data;
                for(var i = 0; i < json.length; i++) {
                  var obj = json[i];
                  if(obj.uniprot.includes(d.name)) {
                    code[j] = obj;  
                    j = j + 1;
                  }
                }
              $("#list").remove();
              $("#collaps").remove();
              $(".btn").remove();
              for (var i = 0; i <= counter; i++) {
                $("#list" + i + "").remove();
                $("#collaps" + i + "").remove();
              }
              counter = 0;
              for(var i in code) {
                $("#intermediary").append("<button type='button' class='btn btn-info' data-toggle='collapse' data-target='#collaps" + i + "'>" + code[i].pdb + "</button>");
                $("#intermediary").append("<div id='collaps" + i + "' class='collapse'></div>");
                $("#collaps" + i + "").append("<ul id='list" + i + "'></ul>");
                var li = "<li id=first><a href='"; 
                var name = "radialProt.html?name=" + code[i].pdb + "&plotname=" + code[i].short_exp_cond_description + "&uniprot=" + code[i].uniprot + "&status=" + single + "&singleName=" + code[i].uniprot + "_" + code[i].pdb + "_" + code[i].vmd_chain_id.charAt(0) +  "'>"+code[i].pdb;
                $("#list" + i + "").append(li.concat(name))
                  .append("<li>".concat("Receptor: " + code[i].receptor))
                  .append("<li>".concat("Uniprot: " + code[i].uniprot))
                  .append("<li>".concat("State: " + code[i].state))
                  .append("<li>".concat("Ligand: " + code[i].ligand))
                  .append("<li>".concat("Publication: " + code[i].publication))
                  .append("<li>".concat("Condition/Rep: " + code[i]['condition/rep']))
                  .append("<li>".concat("Sherlock Path: " + code[i].sherlock_path))
                  .append("<li>".concat("Top Dir: " + code[i].top_dir))
                  .append("<li>".concat("Traj Dir: " + code[i].traj_dir))
                  .append("<li>".concat("Filetype: " + code[i].filetype))
                  .append("<li>".concat("Sim Tool: " + code[i].sim_tool))
                  .append("<li>".concat("Strip Water: " + code[i].strip_water))
                  .append("<li>".concat("VMD Chain ID: " + code[i].vmd_chain_id))
                  .append("<li>".concat("MDTRAJ Chain ID: " + code[i].mdtraj_chain_id))
                  .append("<li>".concat("Short Exp Cond Description: " + code[i].short_exp_cond_description))
                  .append("<li>".concat("Lond Exp Cond Description: " + code[i].long_exp_cond_description))
                  .append("<li>".concat("3.5A Inter Dict Dir: " + code[i]["3.5A_inter_dict_dir"]))
                  .append("<li>".concat("3.2A Inter Dict Dir: " + code[i]["3.2A_inter_dict_dir"]))                
                  .append("<li>".concat("Subsampled Traj: " + code[i].subsampled_traj))
                  .append("<li>".concat("Ligand Resn: " + code[i].ligand_resn));
                counter = i;
              }
            });  
          }); 

          node.append("text")
              .attr("dy", ".31em")
              .attr("text-anchor", function(d) { return d.x < 180 ? "start" : "end"; })
              .attr("transform", function(d) { return d.x < 180 ? "translate(8)" : "rotate(180)translate(-8)"; })
              .text(function(d) { return d.name; });
            
          node
            .append("a")
            //.attr("xlink:href", function (d) { return "intermediary.html" + "?name=" + d.name; })
            .on("click", function(d) {
                //window.location = "intermediary.html" + "?name=" + d.name;
                var json;
                var code = [];
                var j = 0;
                $.getJSON('table.json').done(function (data) {
                  json = data;
                  for(var i = 0; i < json.length; i++) {
                    var obj = json[i];
                    console.log(d.name)
                    if(obj.uniprot.includes(d.name)) {
                      code[j] = obj;  
                      j = j + 1;
                    }
                  }
                });
                $("#list").remove();
                $("#collaps").remove();
                $(".btn").remove();
                for (var i = 0; i <= counter; i++) {
                  $("#list" + i + "").remove();
                  $("#collaps" + i + "").remove();
                }
                counter = 0;
                for(var i in code) {
                  $("#intermediary").append("<button type='button' class='btn btn-info' data-toggle='collapse' data-target='#collaps" + i + "'>" + code[i].pdb + "</button>");
                  $("#intermediary").append("<div id='collaps" + i + "' class='collapse'></div>");
                  $("#collaps" + i + "").append("<ul id='list" + i + "'></ul>");
                  var li = "<li id=first><a href='"; 
                  var name = "radialProt.html?name=" + code[i].pdb + "&plotname=" + code[i].short_exp_cond_description + "&uniprot=" + code[i].uniprot + "&status=" + single + "&singleName=" + code[i].uniprot + "_" + code[i].pdb + "_" + code[i].vmd_chain_id.charAt(0) +  "'>"+code[i].pdb;
                  $("#list" + i + "").append(li.concat(name))
                    .append("<li>".concat("Receptor: " + code[i].receptor))
                    .append("<li>".concat("Uniprot: " + code[i].uniprot))
                    .append("<li>".concat("State: " + code[i].state))
                    .append("<li>".concat("Ligand: " + code[i].ligand))
                    .append("<li>".concat("Publication: " + code[i].publication))
                    .append("<li>".concat("Condition/Rep: " + code[i]['condition/rep']))
                    .append("<li>".concat("Sherlock Path: " + code[i].sherlock_path))
                    .append("<li>".concat("Top Dir: " + code[i].top_dir))
                    .append("<li>".concat("Traj Dir: " + code[i].traj_dir))
                    .append("<li>".concat("Filetype: " + code[i].filetype))
                    .append("<li>".concat("Sim Tool: " + code[i].sim_tool))
                    .append("<li>".concat("Strip Water: " + code[i].strip_water))
                    .append("<li>".concat("VMD Chain ID: " + code[i].vmd_chain_id))
                    .append("<li>".concat("MDTRAJ Chain ID: " + code[i].mdtraj_chain_id))
                    .append("<li>".concat("Short Exp Cond Description: " + code[i].short_exp_cond_description))
                    .append("<li>".concat("Lond Exp Cond Description: " + code[i].long_exp_cond_description))
                    .append("<li>".concat("3.5A Inter Dict Dir: " + code[i]["3.5A_inter_dict_dir"]))
                    .append("<li>".concat("3.2A Inter Dict Dir: " + code[i]["3.2A_inter_dict_dir"]))                
                    .append("<li>".concat("Subsampled Traj: " + code[i].subsampled_traj))
                    .append("<li>".concat("Ligand Resn: " + code[i].ligand_resn));
                counter = i;
                }  
          
          }) 
            .append("rect")
            .attr("class", "clickable")
            .attr("cursor", "pointer")
            .attr("y", -6)
            .attr("x", function (d) { return d.children || d._children ? -60 : 10; })
            .attr("width", 50) //2*4.5)
            .attr("height", 12)
            .style("fill", "lightsteelblue")
            .style("fill-opacity", 0);

          function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++ ) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
          }

          function coloring(d) {
            return getRandomColor()
            // return "#FF69B4"
            // return d._children ? "#FF69B4" : d.children ? "#c6dbef" : "#fd8d3c";
          }
        });
          
        }
          
        createAll();

        d3.select(self.frameElement).style("height", diameter - 150 + "px");
        </script>
    </body>
</html>