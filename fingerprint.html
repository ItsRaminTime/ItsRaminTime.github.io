<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  
  <title>GPCR Fingerprint</title>
  
  <script src="https://d3js.org/d3.v3.js"></script>
  <link rel="stylesheet" type="text/css" href="dropdown.css" media="screen">
  
  <!-- Javascript libs -->
  <script type="text/javascript" src="./flareplot-main.js"></script>
  <script type="text/javascript" src="./flareplot-selectors.js"></script>
  <script type="text/javascript" src="./flareplot-fingerprintpanel.js"></script>

  <!-- Visualization CSS -->
  <link href="./flareplot-main.css" rel="stylesheet">
  <link href="./flareplot-selectors.css" rel="stylesheet">
  <link href="./flareplot-fingerprintpanel.css" rel="stylesheet">
  
  <link rel="stylesheet" type="text/css" href="normalize.css" media="screen">
  <link rel="stylesheet" type="text/css" href="gpcr_demo.css" media="screen">
  
  <script type="text/javascript" src="./parse.js"></script>
  <script type="text/javascript" src="./main.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>

  
  <script
  src="https://code.jquery.com/jquery-2.2.4.min.js"
  integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
  crossorigin="anonymous"></script>
  <script type="text/javascript" src="./parse.js"></script>
  <script type="text/javascript" src="pv.min.js"></script>
  <script type="text/javascript" src="./main.js"></script>
    
  <!-- FlarePlot javascript files -->
  <script src="http://cdn.rawgit.com/GPCRviz/FlarePlot/master/flareplot-main.js"></script>

  <!-- FlarePlot styling -->
  <link href="http://cdn.rawgit.com/GPCRviz/FlarePlot/master/flareplot-main.css" rel="stylesheet">
    
</head>
  <body>
    
    <h1 id="header" style='text-align: center'></h1>
    <div style="width: 100%;">
      <div class="container" id="maincontent" style="float:left; width: 45%; padding-top: 10px;"></div>
      <div style="float:left; width: 10%;">
        <div class="dropdown" style="postion: center;">
          <button onclick="drop()" class="dropbtn" style="padding-right: 30px; padding-left: 30px;">Protein PDBS</button>
          <div id="myDropdown" class="dropdown-content">
          </div>
        </div>
      </div>
      <div id="pviewerEncompasser" style="float:right; width: 45%;">
        <div id='picked-atom-label' style='text-align:center;'>Currently Selected Atom:</div>
        <div id='picked-atom-name' style='text-align:center;'></div>
        <div id="pviewer" ></div>
      </div>
    </div>

    <script>
      
      function getQueryVariable() {
        var query = window.location.search.substring(1);
        var params = []
        var vars = query.split("&");
        for (var i=0;i<vars.length;i++) {
          var pair = vars[i].split("=");
          params.push(pair[1])
        }
        return params;
      }
  
      var params = getQueryVariable();
      var cluster = params[0];
      console.log(cluster);
      var list_pdbs = params[1].split(";");
      console.log(list_pdbs);
      var unique_pdbs = [];
      $.each(list_pdbs, function(i, el){
        if($.inArray(el, unique_pdbs) === -1) unique_pdbs.push(el);
      });
      list_pdbs = unique_pdbs;
      console.log(list_pdbs);
      for (var i = 0; i < list_pdbs.length; i++) {
        var id = "" + list_pdbs[i];
        $("#myDropdown").append("<a id='" + id + "'>" + id + "</a>");
        console.log(id);
        document.getElementById(id).addEventListener("click", (function(t){return function(){change_pdb(t);};})(id), false);
      }
      var contents;
      var flareplot;
      var panel;
      document.getElementById("header").innerHTML = "GPCR Fingerprints for Cluster #" + cluster;
      
      
     
      function drop_mol(index) {
        var name = "myDropdown_" + index + "";
        document.getElementById(name).classList.toggle("show");
      } 
        
      /* When the user clicks on the button, 
      toggle between hiding and showing the dropdown content */
      function drop() {
        document.getElementById("myDropdown").classList.toggle("show");
      }
      
      function change_pdb(pdb_name) {
        loadMOR(pdb_name);
      }
            
      create_fingerprint_graph("hbsb");
      
      function create_fingerprint_graph(interaction_group) {
        document.getElementById("maincontent").innerHTML = "";
        d3.json("/Fingerprints/cluster_" + cluster + "/" + interaction_group + ".json", function(jsonData){
          contents = jsonData;
          console.log(contents)
          flareplot = createFlareplot(600, jsonData, "#maincontent");
          d3.select("#maincontent div")
            .style("position","relative")
            .style("left","50%")
            .style("margin-left","-300px");
        
          var selectorContainer = d3.select("#maincontent").append("div");
          var selectorAdded = createSelectors(flareplot, selectorContainer.node());
          if( !selectorAdded ){
            selectorContainer.remove();
          }
          // Create fingerprint panel if frameDict is included in contents
          frameDict = getFrameDict(contents)
        
          if(frameDict){
            flareplot.framesIntersect([]) //show all interactions to begin with
            var columnNames = getFingerprintColumns(contents);
            var fingerprint_list = calcFingerprints(contents);
            panel = initScrollableFingerprintPanel(
                "#maincontent", // Container selector
                columnNames,
                fingerprint_list,
                threeStateRowSelection,
                true, // Show header
                '70px' // Height of column headers
            );
            //panel = initFingerprintPanel("#maincontent", columnNames, threeStateSelection, true, '75px');
            panel.on("click", updateIntersectFrames)
          } 
        });
      }
      
      
      //PDB
      // override the default options with something less restrictive.
      var options = {
        width: 500,
        height: 800,
        antialias: true,
        quality : 'medium',
      };

      var gpcrdb_numbers_file = "gpcrdb_numbers.txt";

      var nameToResiTable = {};

      $.ajax({
        url : "gpcrdb_numbers.txt",
        dataType: "text",
        success : function (data) {
          var value_array = [];
          var num = "";
          var lines = data.split('\n');
          for (var i = 0; i < lines.length; i++) {
            var tabs = lines[i].split('\t');
            if (tabs[0].toLowerCase() !== uniprot) {
              //i = i + 459;
            } else {
              if (tabs[4] !== "None") {
                value_array.push(tabs[1]);
                value_array.push("");
                num = tabs[4].substring(0, tabs[4].indexOf(".")) + tabs[4].substring(tabs[4].indexOf(".") + 3, tabs[4].length);
                nameToResiTable[num] = value_array;
                value_array = [];
                num = "";
              }
            }
          }
        }
      }); 

      // insert the viewer under the Dom element with id 'gl'.
        var viewer = pv.Viewer(document.getElementById('pviewer'), options);

        function setColorForAtom(go, atom, color) {
        var view = go.structure().createEmptyView();
        view.addAtom(atom);
        go.colorBy(pv.color.uniform(color), view);
    }

    // variable to store the previously picked atom. Required for resetting the color
    // whenever the mouse moves.
    var prevPicked = null;
    // add mouse move event listener to the div element containing the viewer. Whenever
    // the mouse moves, use viewer.pick() to get the current atom under the cursor.

    viewer.on('click', function(picked, ev) {
        var rect = viewer.boundingClientRect();
        var picked = viewer.pick({ x : ev.clientX - rect.left,
                                   y : ev.clientY - rect.top });
        if (prevPicked !== null && picked !== null &&
            picked.target() === prevPicked.atom) {
          return;
        }
        if (prevPicked !== null) {
          // reset color of previously picked atom.
          setColorForAtom(prevPicked.node, prevPicked.atom, prevPicked.color);
        }
        if (picked !== null) {
          var atom = picked.target();
          document.getElementById('picked-atom-name').innerHTML = atom.qualifiedName();
          // get RGBA color and store in the color array, so we know what it was
          // before changing it to the highlight color.
          var color = [0,0,0,0];
          picked.node().getColorForAtom(atom, color);
          prevPicked = { atom : atom, color : color, node : picked.node() };

          setColorForAtom(picked.node(), atom, 'red');
        } else {
          document.getElementById('picked-atom-name').innerHTML = '&nbsp;';
          prevPicked = null;
        }
        viewer.requestRedraw();

      document.getElementById('picked-atom-name').innerHTML = atom.qualifiedName();
      var atomNum = atom.qualifiedName().match(/\d+/)[0];
      toggleResi(atomNum);
    });

      var struc;
        var a;


      function loadMOR(name) {
        // asynchronously load the PDB file for the dengue methyl transferase
        // from the server and display it in the viewer.
        pv.io.fetchPdb("Proteins/" + name + ".pdb", function(structure) {
          struc = structure;
          a = viewer.trace('protein', structure, { color : color.ssSuccession() });
          var ligands = structure.select({ rnames : ['YCM', '4VO', 'OLC', 'CLR', 'P04', 'P6G'] });
          viewer.ballsAndSticks('ligands', ligands);
          viewer.fitTo(structure);
          viewer.setRotation([1,0,0,0,0,1,0,-1,0]);
        });
      }

      // load the methyl transferase once the DOM has finished loading. That's
      // the earliest point the WebGL context is available.
      document.addEventListener('DOMContentLoaded', loadMOR(list_pdbs[0]));
    </script>
    
  </body>
</html>